---
title: 'OHI-Northeast: Livelihoods'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohi-northeast/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---


``` {r setup, echo=F, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(fig.width = 8, fig.height = 6, fig.path = 'figs/', message = FALSE, warning = FALSE)

dir_git <- '~/github/ohi-northeast'
source(file.path(dir_git, 'src/R/common.R'))  ### an OHI-NE specific version of common.R

library(tidyverse)
library(readxl)
library(DT)
library(plotly)
#install.packages("striprtf")
library(striprtf)

dir_anx <- file.path(dir_M, 'git-annex/neprep')

```

#Summary

The Livelihoods sub-goal is calculated using coastal employment data from the [National Ocean Economics Program](http://www.oceaneconomics.org/), and State-wide employment from the [Bureau of Labor Statistics](http://www.bls.gov/data/).

***

# Data Sources

### National ocean Economics Program (NOEP)

**Downloaded**: Received from Pat Johston on October 3, 2017.  
**Description**:  Total number of jobs and wages per sector for RI, ME, MA, CT, NY and NH counties from 2005 to 2013. The data also include number of establishments and GDP for each sector - state - year.  
**Native data resolution**: County level     
**Time range**: 2005 - 2014  
**Format**:  Tabular  


### US Bureau of Labor Statistics

**Downloaded**: May 17, 2016  
**Description**: Total Annual Employment (in thousands) per State from 1990 to 2015  
**Native data resolution**: State level  
**Time Range:** 2005 to 2015  
**Format:** Tabular  


***

# Load data

## NOEP data

Two sets of data are provided, one for the timeframe 1990 - 2004 and the other from 2005 - 2014. NOEP recommends not using these two together due to inconsistincies across the two, especially in regards to GDP. While both are read in here, we only use the 2005 - 2014 data to calculate the LIV goal for now.

```{r coastal_data}

## Read in raw data which came in .xlsx format with 2 sheets. 

## read in NOEP sheet for all data 1990 - 2004
noep_data_1 <- read_excel(file.path(dir_anx, '_raw_data/NOEP/New_England_ocean_series.xlsx'), sheet = "NOEP")
  
## read in ENOW sheet which contains data for 2005 - 2014 
noep_data_2 <- read_excel(file.path(dir_anx, '_raw_data/NOEP/New_England_ocean_series.xlsx'), sheet = "ENOW")
```

Moving forward just with the more recent data series. Data is provided for each individual coastal county as well as "All Counties" in each state. There is an important distinction between using "All Counties" and simply summing up all state county data. Some data at the county level is supressed due to regulation. But when reported at the State level, this data may be released. We see this when looking at New Hampshires marine transportation data. The sum of NH's two coastal counties for jobs does not equal the reported value for jobs for "All New Hampshire Counties". This is most likely due to data supression at the county level. Therefore we use the sum of all counties rather than the data reported for "All Counties".

```{r}
# need to read in the MA counties since they are divided across two bioregions

ma_ctys <- read_csv("~/github/ohi-northeast/src/tables/MA_counties.csv")

clean_data <- noep_data_2 %>%
       filter(Sector == 'All Ocean Sectors') %>%
        left_join(rgn_data, by = c("State" = "rgn_name")) %>%
        left_join(ma_ctys, by = c("State", "County")) %>%
        mutate(rgn_id = ifelse(is.na(rgn_id.x), rgn_id.y, rgn_id.x),
               rgn_name = ifelse(is.na(rgn_name), State, rgn_name)) %>%
  select(-rgn_id.x, -rgn_id.y, -area_km2.x, -area_km2.y, -rgn_abrev.x, -rgn_abrev.y) %>%
        mutate(Employment     = ifelse(rgn_name %in% c("Massachusetts-Gulf of Maine", "Massachusetts-Virginian"), 
                                      as.numeric(gsub(",","",.$Employment))/2, as.numeric(gsub(",","",.$Employment))),
               Establishments = ifelse(rgn_name %in% c("Massachusetts-Gulf of Maine", "Massachusetts-Virginian"), 
                                       as.numeric(gsub(",","",.$Establishments))/2, as.numeric(gsub(",","",.$Establishments))),
               Wages          = ifelse(rgn_name %in% c("Massachusetts-Gulf of Maine", "Massachusetts-Virginian"), 
                                       as.numeric(gsub(",","",.$Wages))/2, as.numeric(gsub(",","",.$Wages))),
               Wages_2012     = ifelse(rgn_name %in% c("Massachusetts-Gulf of Maine", "Massachusetts-Virginian"),
                                       as.numeric(gsub(",","",.$Wages_2012))/2, as.numeric(gsub(",","",.$Wages_2012))),
               GDP            = ifelse(rgn_name %in% c("Massachusetts-Gulf of Maine", "Massachusetts-Virginian"),
                                       as.numeric(gsub(",","",.$GDP))/2, as.numeric(gsub(",","",.$GDP))),
               GDP_2012       = ifelse(rgn_name %in% c("Massachusetts-Gulf of Maine", "Massachusetts-Virginian"),
                                       as.numeric(gsub(",","",.$GDP_2012))/2, as.numeric(gsub(",","",.$GDP_2012))))

DT::datatable(clean_data, rownames=F, caption = 'Employment in the Tourism & Recreation sector of Coastal Jobs in New England provided by NOEP')

```

Meta-analysis to look at county compared to state totals, just for employment.

```{r state_vs_county_totals}

states <-  c("Maine", "New Hampshire", "Rhode Island", "Massachusetts", "New York", "Connecticut")

meta <- function(state){
  
  all <- clean_data %>%
    filter(State == state,
           str_detect(County, "All")) %>%
    select(Year, Employment) %>%
    rename(all_ctys_employment = Employment)
  
  out <- clean_data %>%
     filter(State == state,
            str_detect(County, "All") == FALSE) %>%
     select(State, County, Year, Employment) %>%
     group_by(Year) %>%
    summarize(totals = sum(Employment, na.rm = T)) %>%
    left_join(all) %>%
    rename(county_totals = totals,
           statewide = all_ctys_employment) %>%
    gather(key = spatial_res, value = Employment, -Year) %>%
    mutate(State = state)
  
return(out)
}

t <- map_df(states, meta)

ggplot(t, aes(x = Year, y = Employment, color = spatial_res))+
    geom_line() +
    facet_wrap(~State, scales = "free")
```

There are some clear discrepancies in the dataset between the total number of jobs reported at the state level ("statewide") and the sum of all employment numbers at the County level. New york and Massachusetts have parallel trends, so using either data stream should result in the same final score. New Hampshire has significantly more statewide jobs beginning in 2011 due to data supression up until that point. We can assume that if data were not suppressed pre-2011 statewide, we would also see parallel trends in New Hampshire as well. Operating under that assumption, we can use the county level data. Rhode Island, Connecticut and Maine show low employment numbers in earlier years when adding up at the county level. This could be due to a lack of data. For example, Saghadoc county in Maine has no data up until 2010, when the jump happens. This suggests we should use the statewide data for Maine. There is no missing data in Connecticut or Rhode Island. This might suggest data suppression in those earlier years at the county level. Therefore the statewide data should be used. 


```{r}

#select the data for ME, CT and RI, which is going to use the data reported for "All x counties"
state_data <- clean_data %>%
  filter(str_detect(County, "All"),
         State %in% c("Maine", "Connecticut", "Rhode Island")) %>%
  select(State, Year, rgn_id, rgn_name, rgn_employment = Employment, rgn_wages = Wages_2012, rgn_estab = Establishments)
  
county_data <- clean_data %>%
  filter(str_detect(County, "All")== FALSE,
         State %in% c("Massachusetts", "New York", "New Hampshire")) %>%
  group_by(rgn_id, Year) %>%
  mutate(rgn_employment = sum(Employment, na.rm = T),
         rgn_wages = sum(Wages_2012, na.rm = T),
         rgn_estab = sum(Establishments, na.rm = T)) %>% #employment by region
  select(State, Year, rgn_id, rgn_name, rgn_employment, rgn_wages, rgn_estab) %>%
  distinct()

jobs_data <- bind_rows(state_data, county_data) %>%
  select(-rgn_wages, -rgn_estab) %>%
  write_csv(file.path(dir_calc, "layers/liv_coast_jobs.csv"))

```

## Visualize jobs by region

```{r}

ggplot(jobs_data, aes(x = Year, y = rgn_employment)) +
  geom_line()+
  facet_wrap(~ rgn_name, scales = "free")


```

<br>
*****
<br>

## BLS data

We use the BLS data to get information on statewide employment.

The Bureau of Labor Statistics has a clunky online data query that is less than ideal for downloading data. They do have an API and I found a couple different R packages for accessing it. For now, I'm using [`blscrapeR`](https://github.com/keberwein/blscrapeR) which fortunately has a function to access state data by month. Since we are interested in annual averages, it requires some additional aggregating but seems to work quite well and is able to access data from 1976 - current, although we just need 2005 - 2014 to match the NOEP data.


```{r, echo = F, message = F, results='hide'}

#devtools::install_github("keberwein/blscrapeR")
library(blscrapeR)
#read in API access key that is saved on Mazu
blsKey <- read_rtf(file.path(dir_M,'git-annex/neprep/keys/BureauofLaborStatistics.rtf'))
set_bls_key(blsKey, overwrite=TRUE)
```

```{r}
# the R package is a little clunky in that it requires a query using months + years.
out <- c()

for(i in 1990:2016){
mths <- c(paste0("January ", i), paste0("February ", i), paste0("March ", i), paste0("April ", i), paste0("May ", i), 
                 paste0("June ", i), paste0("July ", i), paste0("August ", i), paste0("September ", i), paste0("October ", i), 
          paste0("November ", i), paste0("December ", i))

out <- c(mths, out)
}

## use get_bls_state to query a text file of state data
st_emp <- get_bls_state(date_mth = out, seasonality = FALSE) %>%
  separate(month, into = c("Year", "month", "day"), sep = "-") %>%
  filter(state %in% c("New York", "Massachusetts", "Connecticut", "Rhode Island", "Maine", "New Hampshire")) %>%
  group_by(state, Year, state_abb) %>%
  mutate(yr_avg_employed        = mean(employed),
         yr_avg_employed_rate   = mean(employed_rate),
         yr_avg_unemployed_rate = mean(unemployed_rate)) %>%
  ungroup() %>%
  select(state, Year, yr_avg_employed) %>%
  rename(State = state) %>%
  mutate(Year = as.numeric(Year)) %>%
  distinct() 

write_csv(st_emp, file.path(dir_calc, "layers/liv_state_jobs.csv"))

```

## Visualize

```{r}

ggplot(st_emp%>%filter(Year>2004), aes(x = Year, y = yr_avg_employed)) +
  geom_line() +
  facet_wrap(~State, scales = "free") +
  labs(y = "Annual average employment")

```

***

#Methods

##Jobs

The livelihoods jobs score, $j '$, is calculated using the following equation; 

$$j ' = \frac{\frac{C_{i}}{C_{r}}}{\frac{T_{i}}{T_{r}}}$$

where $C_{i}$ is the number of coastal jobs in year *i*, $C_{r}$ is the number of coastal jobs in 2005, ${T_{i}}$ is the total number of jobs statewide for year *i* and ${T_{r}}$ is the number of jobs statewide in 2005.


```{r jobs}

jobs <- clean_data %>%
      rename(coast_jobs = Employment) %>%
      mutate(County     = ifelse(grepl("All", County), "Statewide", County),
             hist_jobs  = coast_jobs[which.min(Year)]) %>%
      filter(Sector == "All Ocean Sectors",
             County == "Statewide") %>%
      left_join(st_emp, by = c('State', 'Year')) %>%
      mutate(cst_chg = coast_jobs/hist_jobs, #use historical reference point from 2005
                 hist_st_jobs = yr_avg_employed[which.min(Year)],
                 st_chg = yr_avg_employed/hist_st_jobs,
                 score = ifelse((cst_chg/st_chg) > 1, 1, cst_chg/st_chg)) %>%
      as.data.frame() %>%
      select(State, Year, hist_jobs, cst_chg, hist_st_jobs, st_chg, score) %>%
      unique()

## save to output
# add rgn id
# select only year, rgn id and value

write_csv(jobs, "output/le_jobs.csv")

```

```{r jobs_plot}
  
jobs_plot <- ggplot(jobs, aes(x = Year, y = score, group=State)) +
  ggtheme_plot +
  geom_point(aes(color = State)) +
            geom_line(aes(color = State)) +
            scale_y_continuous(limits = c(0, 1)) +
            ggtitle("Jobs Scores for the Northeast") +
  labs(y = 'Score')

ggplotly(jobs_plot)

ggsave('figs/jobs_scores.png')

```

## Wages

The livelihoods wages score, $g'$ is calculated using the following equation;

$$g ' = \frac{\frac{C_{i}}{C_{r}}}{\frac{T_{i}}{T_{r}}}$$

These wage statistics came from BLS.gov. I had to manually query their online database and copy and paste the data for each county into an excel sheet (bls_wages.csv). I have not 
```{r wages}

#now that we can get wages using the blscrapeR package, we don't need to use this bls_wages.csv that I had previously downloaded. I did compare this dataset to the one retrieved from the API and they are the same. In the future we can likely delete the bls_wages.csv data but I'm holding onto it for now.
#old_bls_wages <- read.csv('bls_wages.csv', stringsAsFactors=FALSE)

wage_codes <- read_rtf('ne_wages_codes') %>%
  gsub(pattern = "E", replacement = " E") %>%
  strsplit(split = " ") %>%
  unlist()

state_lookup <- read_csv("bls_code_lookup.csv")

#only 50 seriesIDs can be submitted to the API at once. Since there are more than 50 seriesIDs we need to do it in batches
bls_data_1 <- bls_api(wage_codes[2:51],
              startyear = 2005, endyear = 2014, registrationKey = "BLS_KEY") %>%
  as.data.frame()
bls_data_2 <- bls_api(wage_codes[52:102],
              startyear = 2005, endyear = 2014, registrationKey = "BLS_KEY") %>%
  as.data.frame()
bls_data_3 <- bls_api(wage_codes[103:length(wage_codes)],
              startyear = 2005, endyear = 2014, registrationKey = "BLS_KEY") %>%
  as.data.frame()

#combine them all
bls_wages <- bls_data_1 %>%
  rbind(bls_data_2) %>%
  rbind(bls_data_3) %>%
  mutate(seriesID = as.character(.$seriesID)) %>%
  left_join(state_lookup, by = c("seriesID" = "code")) %>%
  filter(county == "Statewide") %>%
  group_by(state, year) %>%
  mutate(annual_wage = sum(value)) %>%
  select(year, state, annual_wage) %>%
  distinct()
  

wages <- data%>%
          mutate(County      = ifelse(grepl("All", County), "Statewide", County),
                 coast_wages = as.numeric(gsub(",", "", Wages_2012)),
                 hist_wages  = coast_wages[which.min(Year)]) %>%
          dplyr::select(-Employment, -Wages, -Wages_2012, -GDP, -GDP_2012) %>%
          filter(County == "Statewide") %>%
          left_join(bls_wages, by = c("State" = "state", "Year" = "year")) %>%
          mutate(w_cst_chg     = coast_wages/hist_wages, #use historical reference point from 2005
                 hist_st_wages = annual_wage[which.min(Year)],
                 w_st_chg      = annual_wage/hist_st_wages,
                 wages_score   = ifelse((w_cst_chg/w_st_chg) > 1, 1, w_cst_chg/w_st_chg)) 

```


```{r plot_wages}

#by state

s_plot <- ggplot(wages,aes(x = Year, y = wages_score, group=State)) +
  ggtheme_plot +
  geom_point(aes(color = State)) +
            geom_line(aes(color = State)) +
            scale_y_continuous(limits = c(0, 1)) + 
            ggtitle("Wages Scores for the Northeast Regions") +
  labs(y = 'Score')


ggplotly(s_plot)

ggsave('figs/state_wages_scores.png')
            
#by county
#             
# c    <- wages%>%
#       filter(County != 'Statewide') 
# 
# c_plot <- ggplot(c,aes(x = Year,y = wages_score, group=County))+
#   ggtheme_plot+
#   geom_point(aes(color = County)) +
#             geom_line(aes(color = County))+
#             scale_y_continuous(limits = c(0,1))+
#             ggtitle("Wages Scores for the Northeast Regions")+
#   labs(y = 'Score')
#             
#            
# ggplotly(c_plot)
# 
# ggsave('figs/wages_county_scores.png')
```



***

#Results

Now to calculate the livelihoods sub goal we need to bring jobs and wages together

```{r liv_score}

# Combine wages and jobs data

liv <- jobs%>%
        left_join(wages)%>%
       mutate(liv_score = (score + wages_score)/2)

liv_plot <- ggplot(liv, aes(x = Year, y = liv_score, group = County))+
  ggtheme_plot+
  geom_point(aes(color = County)) +
  geom_line(aes(color = County))+
  scale_y_continuous(limits = c(0, 1))+
  ggtitle("Livelihood Scores for the Northeast Regions")+
  labs(y = 'Score')
            
            
#aggregate by state (take the mean)
            
liv_st <- liv%>%
            group_by(State, Year)%>%
            summarise(st_score = mean(liv_score, na.rm=T))

liv_st_plot <- ggplot(liv_st, aes(x = Year, y = st_score, group = State)) +
  ggtheme_plot +
  geom_point(aes(color = State)) +
            geom_line(aes(color = State)) +
            scale_y_continuous(limits = c(0,1)) +
            ggtitle("Livelihood Scores for the Northeast Regions")+ 
  labs(y = 'Score')

ggplotly(liv_st_plot)

ggsave('figs/liv_scores.png') 
```


**Looking specifically at New Hampshire**

New Hampshire shows a significant jump. It looks like this is due to a large improvement in both Employment and Wages in 2011. This increase seems to stray from the pattern of Statewide values being roughly equal to the total Employment/Wages of the two counties. On 10/10/17 I reached out to Pat Johnston to ask for clarification on the data.

```{r}

nh_data <- data %>%
  filter(State == "New Hampshire") %>%
      mutate(County     = ifelse(grepl("All", County), "Statewide", County)) %>%
      filter(Sector == "All Ocean Sectors") %>%
      select(State, County, Year, Employment) %>%
      unique() %>%
      spread(County, value = Employment)  %>%
  mutate(rock_plus_straf = Rockingham+Strafford) %>%
  select(Year, Statewide,rock_plus_straf, Rockingham, Strafford)

DT::datatable(nh_data)

nh_wages <- data %>%
  filter(State == "New Hampshire") %>%
      mutate(County     = ifelse(grepl("All", County), "Statewide", County)) %>%
      filter(Sector == "All Ocean Sectors") %>%
      select(State, County, Year, Wages_2012) %>%
      unique() %>%
      spread(County, value = Wages_2012) %>%
  mutate(rock_plus_straf = Rockingham+Strafford) %>%
  select(Year, Statewide,rock_plus_straf, Rockingham, Strafford)
  
DT::datatable(nh_wages)

```


***

#Citation information  

National Ocean Economics Program. Ocean Economic Data by Sector & Industry., ONLINE. 2012.
Available: http://www.OceanEconomics.org/Market/oceanEcon.asp [17 May 2016]


Bureau of Labor Statistics, U.S. Department of Labor, Quarterly Census of Employment and Wages. 7/24/2016. http://www.bls.gov/cew/](http://www.bls.gov/cew/).