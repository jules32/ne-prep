---
title: 'OHI-Northeast: Livelihoods'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohi-northeast/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---


``` {r setup, echo=F, message = FALSE, warning = FALSE, results = 'hide'}
knitr::opts_chunk$set(fig.width = 10, fig.height = 6, fig.path = 'figs/', message = FALSE, warning = FALSE)

dir_git <- '~/github/ohi-northeast'
source(file.path(dir_git, 'src/R/common.R'))  ### an OHI-NE specific version of common.R

library(tidyverse)
library(readxl)
library(DT)
library(plotly)
#install.packages("striprtf")
library(striprtf)
library(zoo)

dir_anx <- file.path(dir_M, 'git-annex/neprep')

```

#Summary

The Livelihoods sub-goal is calculated using coastal employment and wage data from the [National Ocean Economics Program](http://www.oceaneconomics.org/), and state-wide employment and wage data from the [Bureau of Labor Statistics](http://www.bls.gov/data/).

***

# Data Sources

## National ocean Economics Program (NOEP)

**Downloaded**: Received from Pat Johston on October 3, 2017.  
**Description**:  Total number of jobs and wages per sector for RI, ME, MA, CT, NY and NH counties from 2005 to 2013. The data also include number of establishments and GDP for each sector - state - year.  
**Native data resolution**: County level     
**Time range**: 2005 - 2014  
**Format**:  Tabular  


## US Bureau of Labor Statistics

**Downloaded**: `r date()` 
**Description**: Total Annual Employment (in thousands) & Average annual wages (USD)  
**Native data resolution**: County level  
**Time Range:** 1990 to 2016  
**Format:** Tabular  


***

# Jobs

The livelihoods jobs score, $j '$, is calculated using the following equation; 

$$j ' = \frac{\frac{C_{i}}{C_{r}}}{\frac{T_{i}}{T_{r}}}$$

where $C_{i}$ is the number of coastal jobs in year *i*, $C_{r}$ is the average number of coastal jobs over the previous 5 years (*i*-6 to *i* - 1), ${T_{i}}$ is the total number of jobs statewide for year *i* and ${T_{r}}$ is the average number of statewide jobs over the previous 5 years.


## Coastal jobs

Two sets of data from NOEP are provided, one for the timeframe 1990 - 2004 and the other from 2005 - 2014. NOEP recommends not using these two together due to inconsistincies across the two, especially in regards to GDP. While both are read in here, we only use the 2005 - 2014 data to calculate the LIV goal for now.

```{r coastal_data}

## Read in raw data which came in .xlsx format with 2 sheets. 

## read in NOEP sheet for all data 1990 - 2004
noep_data_1 <- read_excel(file.path(dir_anx, '_raw_data/NOEP/New_England_ocean_series.xlsx'), sheet = "NOEP")
  
## read in ENOW sheet which contains data for 2005 - 2014 
noep_data_2 <- read_excel(file.path(dir_anx, '_raw_data/NOEP/New_England_ocean_series.xlsx'), sheet = "ENOW")
```

Moving forward just with the more recent data series. Data is provided for each individual coastal county as well as "All Counties" in each state. There is an important distinction between using "All Counties" and simply summing up all state county data. Some data at the county level is supressed due to regulation. But when reported at the State level, this data may be released. We see this when looking at New Hampshires marine transportation data. The sum of NH's two coastal counties for jobs does not equal the reported value for jobs for "All New Hampshire Counties". This is most likely due to data supression at the county level. Therefore we use the sum of all counties rather than the data reported for "All Counties".

```{r split_MA}
# need to read in the MA counties since they are divided across two bioregions

ma_ctys <- read_csv("~/github/ohi-northeast/src/tables/MA_counties.csv")

clean_data <- noep_data_2 %>%
       filter(Sector == 'All Ocean Sectors') %>%
        left_join(rgn_data, by = c("State" = "rgn_name")) %>%
        left_join(ma_ctys, by = c("State", "County")) %>%
        mutate(rgn_id = ifelse(is.na(rgn_id.x), rgn_id.y, rgn_id.x),
               rgn_name = ifelse(is.na(rgn_name), State, rgn_name)) %>%
  select(-rgn_id.x, -rgn_id.y, -area_km2.x, -area_km2.y, -rgn_abrev.x, -rgn_abrev.y) %>%
        mutate(Employment     = ifelse(rgn_name %in% c("Massachusetts-Gulf of Maine", "Massachusetts-Virginian"), 
                                      as.numeric(gsub(",","",.$Employment))/2, as.numeric(gsub(",","",.$Employment))),
               Establishments = ifelse(rgn_name %in% c("Massachusetts-Gulf of Maine", "Massachusetts-Virginian"), 
                                       as.numeric(gsub(",","",.$Establishments))/2, as.numeric(gsub(",","",.$Establishments))),
               Wages          = ifelse(rgn_name %in% c("Massachusetts-Gulf of Maine", "Massachusetts-Virginian"), 
                                       as.numeric(gsub(",","",.$Wages))/2, as.numeric(gsub(",","",.$Wages))),
               Wages_2012     = ifelse(rgn_name %in% c("Massachusetts-Gulf of Maine", "Massachusetts-Virginian"),
                                       as.numeric(gsub(",","",.$Wages_2012))/2, as.numeric(gsub(",","",.$Wages_2012))),
               GDP            = ifelse(rgn_name %in% c("Massachusetts-Gulf of Maine", "Massachusetts-Virginian"),
                                       as.numeric(gsub(",","",.$GDP))/2, as.numeric(gsub(",","",.$GDP))),
               GDP_2012       = ifelse(rgn_name %in% c("Massachusetts-Gulf of Maine", "Massachusetts-Virginian"),
                                       as.numeric(gsub(",","",.$GDP_2012))/2, as.numeric(gsub(",","",.$GDP_2012))))

DT::datatable(clean_data, rownames=F, caption = 'Employment in the Tourism & Recreation sector of Coastal Jobs in New England provided by NOEP')

```

### Meta-analysis

Look at county compared to state totals, just for employment.

```{r noep_state_vs_county_totals}

states <-  c("Maine", "New Hampshire", "Rhode Island", "Massachusetts", "New York", "Connecticut")

meta <- function(state){
  
  all <- clean_data %>%
    filter(State == !!state,
           str_detect(County, "All")) %>%
    select(Year, Employment) %>%
    rename(all_ctys_employment = Employment)
  
  out <- clean_data %>%
     filter(State == !!state,
            str_detect(County, "All") == FALSE) %>%
     select(State, County, Year, Employment) %>%
     group_by(Year) %>%
    summarize(totals = sum(Employment, na.rm = T)) %>%
    left_join(all) %>%
    rename(county_totals = totals,
           statewide = all_ctys_employment) %>%
    gather(key = spatial_res, value = Employment, -Year) %>%
    mutate(State = state)
  
return(out)
}

t <- map_df(states, meta) %>%
  distinct()

ggplot(t, aes(x = Year, y = Employment, color = spatial_res))+
    geom_line() +
    facet_wrap(~State, scales = "free") +
  scale_color_manual(" ", labels = c("Sum of county reported employment", "Statewide reported employment"), values = c("blue", "red"))
```

There are some clear discrepancies in the dataset between the total number of jobs reported at the state level ("statewide") and the sum of all employment numbers at the County level. New york and Massachusetts have parallel trends, so using either data stream should result in the same final score. New Hampshire has significantly more statewide jobs beginning in 2011 due to data supression up until that point. We can assume that if data were not suppressed pre-2011 statewide, we would also see parallel trends in New Hampshire as well. Operating under that assumption, we can use the county level data. Rhode Island, Connecticut and Maine show low employment numbers in earlier years when adding up at the county level. This could be due to a lack of data. For example, Saghadoc county in Maine has no data up until 2010, when the jump happens. This suggests we should use the statewide data for Maine. There is no missing data in Connecticut or Rhode Island. This might suggest data suppression in those earlier years at the county level. Therefore the statewide data should be used. 


```{r combine_noep_state_county_data}

#select the data for ME, CT and RI, which is going to use the data reported for "All x counties"
state_data <- clean_data %>%
  filter(str_detect(County, "All"),
         State %in% c("Maine", "Connecticut", "Rhode Island")) %>%
  select(state = State, year = Year, rgn_id, rgn_name, rgn_employment = Employment, rgn_wages = Wages_2012, rgn_estab = Establishments)
  
county_data <- clean_data %>%
  filter(str_detect(County, "All")== FALSE,
         State %in% c("Massachusetts", "New York", "New Hampshire")) %>%
  group_by(rgn_id, Year) %>%
  mutate(rgn_employment = sum(Employment, na.rm = T),
         rgn_wages = sum(Wages_2012, na.rm = T),
         rgn_estab = sum(Establishments, na.rm = T)) %>% #employment by region
  select(state = State, year = Year, rgn_id, rgn_name, rgn_employment, rgn_wages, rgn_estab) %>%
  distinct()

coast_jobs <- bind_rows(state_data, county_data) %>%
  select(-rgn_wages, -rgn_estab)

write.csv(coast_jobs, file.path(dir_calc, "layers/le_coast_jobs.csv"))
```


```{r rgn_coastal_employment}

ggplot(coast_jobs, aes(x = year, y = rgn_employment)) +
  geom_line()+
  facet_wrap(~ rgn_name, scales = "free") +
  ylab("Number of jobs") + 
  xlab("Year") +
  ggtitle("Total employment in coastal jobs")

```

<br>

***

<br>

## State jobs

We use the BLS data to get information on statewide employment.

The Bureau of Labor Statistics has a clunky online data query that is less than ideal for downloading data. They do have an API and I found a couple different R packages for accessing it. For now, I'm using [`blscrapeR`](https://github.com/keberwein/blscrapeR) which fortunately has a function to access state data by month. Since we are interested in annual averages, it requires some additional aggregating but seems to work quite well and is able to access data from 1976 - current, although we just need 2005 - 2014 to match the NOEP data.


```{r, echo = F, message = F, results='hide'}

#devtools::install_github("keberwein/blscrapeR")
library(blscrapeR)
#read in API access key that is saved on Mazu
blsKey <- read_rtf(file.path(dir_M,'git-annex/neprep/keys/BureauofLaborStatistics.rtf'))
set_bls_key(blsKey, overwrite=TRUE)
```

```{r get_bls_job_data}
# the R package is a little clunky in that it requires a query using months + years.
out <- c()

for(i in 1990:2016){
mths <- c(paste0("January ", i), paste0("February ", i), paste0("March ", i), paste0("April ", i), paste0("May ", i), 
                 paste0("June ", i), paste0("July ", i), paste0("August ", i), paste0("September ", i), paste0("October ", i), 
          paste0("November ", i), paste0("December ", i))

out <- c(mths, out)
}

## use get_bls_state to query a text file of state data
st_jobs <- get_bls_state(date_mth = out, seasonality = FALSE) %>%
  separate(month, into = c("Year", "month", "day"), sep = "-") %>%
  filter(state %in% c("New York", "Massachusetts", "Connecticut", "Rhode Island", "Maine", "New Hampshire")) %>%
  group_by(state, Year, state_abb) %>%
  mutate(yr_avg_employed        = mean(employed),
         yr_avg_employed_rate   = mean(employed_rate),
         yr_avg_unemployed_rate = mean(unemployed_rate)) %>%
  ungroup() %>%
  select(state, year = Year, yr_avg_employed) %>%
  mutate(year = as.numeric(year)) %>%
  distinct() %>%
  left_join(rgn_data, by = "state") %>%
  select(-area_km2, -rgn_abrev)

write.csv(st_jobs, file.path(dir_calc, "layers/le_state_jobs.csv"))

```

```{r statewide_jobs_bls}

ggplot(st_jobs%>%filter(year > 2004), aes(x = year, y = yr_avg_employed)) +
  geom_line() +
  facet_wrap(~state, scales = "free") +
  ylab("Number of jobs") +
  xlab("Year") +
  ggtitle("Annual average employment statewide")

```


## Reference point

Our reference point is the average number of jobs over the previous 5 years.

```{r jobs_ref_point}

jobs_cst_ref <- coast_jobs %>%
  arrange(year) %>%
  group_by(rgn_id) %>%
  mutate(coast_jobs_5yr = rollapply(rgn_employment, 5, FUN=mean, align = "right", na.rm=F, partial = T),
         coast_jobs_prev_5yr = lag(coast_jobs_5yr, n = 1)) %>%
  filter(year > 2009) %>%
  select(state, year, rgn_id, rgn_name, ref = coast_jobs_prev_5yr)

write.csv(jobs_cst_ref, file.path(dir_calc, "layers/le_coast_jobs_ref.csv"))

jobs_st_ref <- st_jobs %>%
  arrange(year) %>%
  group_by(rgn_id) %>%
  filter(year > 2004) %>% #need to select only years 2005 and on to match NOEP dataset
  mutate(state_jobs_5yr = rollapply(yr_avg_employed, 5, FUN=mean, align = "right", na.rm=F, partial = T),
         state_jobs_prev_5yr = lag(state_jobs_5yr, n = 1)) %>%
  filter(year > 2009) %>%
  select(state, year, rgn_id, rgn_name, ref = state_jobs_prev_5yr)
  
write.csv(jobs_st_ref, file.path(dir_calc, "layers/le_state_jobs_ref.csv"))

```


**Jobs directly related to ocean in coastal counties**

```{r coastal_jobs_and_ref_point}
c <- coast_jobs %>%
  left_join(jobs_cst_ref) %>%
  select(rgn_id, year, rgn_employment, ref, rgn_name) %>%
  gather(data, jobs, -rgn_id,-year, -rgn_name)

ggplot(c, aes(x = year, y = jobs, color = data)) +
  geom_line() +
  facet_wrap(~rgn_name, scales = "free") +
  ylab("Number of jobs") +
  xlab("Year") +
  ggtitle("Regional employment in coastal jobs") +
  scale_color_manual(" ", labels = c("Mean employment over the \nprevious 5 years","Annual employment"), values = c("red", "blue"))
```

**Statewide employment**

Combine annual reported statewide jobs with the reference period.
```{r}
s <- st_jobs %>%
  left_join(jobs_st_ref) %>%
  filter(!is.na(ref)) %>%
  select(rgn_id, year, yr_avg_employed, ref, rgn_name) %>%
  gather(data, jobs, -rgn_id,-year, -rgn_name)

ggplot(s, aes(x = year, y = jobs, color = data)) +
  geom_line() +
  facet_wrap(~rgn_name, scales = "free")+
  ylab("Number of jobs") +
  xlab("Year") +
  ggtitle("Statewide Employment") +
  scale_color_manual(" ", labels = c("Reference period \n(average employment in previous 5 years)", "Annual average employment"), values = c("red", "blue"))
```

***

# Wages

The livelihoods wages score, $g'$ is calculated using the following equation;

$$g ' = \frac{\frac{C_{i}}{C_{r}}}{\frac{T_{i}}{T_{r}}}$$

where $C_{i}$ is the number of total wages for regional coastal employment in year *i*, $C_{r}$ is the average wages for coastal employment over the previous 5 years (*i*-6 to *i* - 1), ${T_{i}}$ is total wages statewide for year *i* and ${T_{r}}$ is the average statewide wages over the previous 5 years.

## Coastal wages

We already prepped this NOEP dataset above and can just create a new dataframe, `coast_wages` by selecting the `rgn_wages` column rather than `rgn_employment`. Wages are also standardized by total employment to give us a measure of wages per capita as opposed to total wages.

```{r coast_wages}

coast_wages <- bind_rows(state_data, county_data) %>%
  mutate(wages_per_job = rgn_wages/rgn_employment) %>%
  select(state, year, rgn_id, rgn_name, wages_per_job)

write.csv(coast_wages, file.path(dir_calc, "layers/le_coast_wages.csv"))

```


```{r coastal_wages_plot}
ggplot(coast_wages, aes(x = year, y = wages_per_job)) +
  geom_line() +
  ylab("Wages (2012 USD$)") +
  facet_wrap(~ rgn_name, scales = "free") +
  ggtitle("Wages per capita") +
  xlab("Year")
```

## State wages

The BLS identifies their data tables with specific codes called [seriesIDs](https://www.bls.gov/help/hlpforma.htm). Unfortunately the only way to get the list of codes that represent the data we want is to [manually query their site](https://data.bls.gov/cgi-bin/dsrv?en) and collect them and save them in a text file for use with the BLS R package. These codes were collected by doing a manual query on bls.gov for the tables we want, which include Average Annual Pay for all counties in our regoin.

The table `bls_code_lookup.csv` was created manually by matching each SeriesID with the appropriate state and county.

```{r get_bls_wages}

## read in the codes that the BLS website uses to identify specific datasets
wage_codes <- read_rtf('data/ne_wages_codes') %>%
  gsub(pattern = "E", replacement = " E") %>%
  strsplit(split = " ") %>%
  unlist()

state_lookup <- read_csv("data/bls_code_lookup.csv")

## only 50 seriesIDs can be submitted to the API at once. Since there are more than 50 seriesIDs we need to do it in batches
bls_data_1 <- bls_api(wage_codes[2:51],
              startyear = 2005, endyear = 2014, registrationKey = "BLS_KEY") %>%
  as.data.frame()
bls_data_2 <- bls_api(wage_codes[52:102],
              startyear = 2005, endyear = 2014, registrationKey = "BLS_KEY") %>%
  as.data.frame()
bls_data_3 <- bls_api(wage_codes[103:length(wage_codes)],
              startyear = 2005, endyear = 2014, registrationKey = "BLS_KEY") %>%
  as.data.frame()

## combine them all 
bls_wages <- bls_data_1 %>%
  rbind(bls_data_2) %>%
  rbind(bls_data_3) %>%
  mutate(seriesID = as.character(.$seriesID)) %>%
  left_join(state_lookup, by = c("seriesID" = "code")) %>%
  filter(county == "Statewide") %>%
  group_by(state, year) %>%
  select(year, state, annual_wage = value) %>%
  distinct() %>%
  left_join(st_jobs, by = c("state", "year")) %>%
  select(year, state, annual_wage, rgn_id, rgn_name)

write_csv(bls_wages, file.path(dir_calc,"layers/le_state_wages.csv"))

```


```{r statewide_wages_plot}

#by state

ggplot(bls_wages, aes(x = year, y = annual_wage)) +
  geom_line() +
  facet_wrap(~state, scales = "free") +
  ylab("Average wages per job (USD$)") +
  xlab("Year") +
  ggtitle("Statewide wages per job from the Bureau of Labor Statistics")

```

## Reference point

Our reference point is the average wages per capita over the previous 5 years.

```{r coastal_wages_ref_points}

wages_cst_ref <- coast_wages %>%
  arrange(year) %>%
  group_by(rgn_id) %>%
  mutate(coast_wages_5yr = rollapply(wages_per_job, 5, FUN=mean, align = "right", na.rm=F, partial = T),
         coast_wages_prev_5yr = lag(coast_wages_5yr, n = 1)) %>%
  filter(year > 2009) %>%
  select(state, year, rgn_id, rgn_name, ref = coast_wages_prev_5yr)

write.csv(wages_cst_ref, file.path(dir_calc, "layers/le_coast_wages_ref.csv"))
```

**Wages per job directly related to ocean in coastal counties**

```{r coastal_wages_and_ref_point}

c <- coast_wages %>%
  left_join(wages_cst_ref) %>%
  select(rgn_id, year, wages_per_job, ref, rgn_name) %>%
  gather(data, wages, -rgn_id,-year, -rgn_name)

ggplot(c, aes(x = year, y = wages, color = data)) +
  geom_line() +
  facet_wrap(~rgn_name, scales = "free") +
  ylab("Wages per job (2009 USD$") +
  xlab("Year") +
  ggtitle("Average annual wages for coastal jobs") +
  scale_color_manual(" ", labels = c("Mean wages over the \nprevious 5 years","Annual average wages"), values = c("red", "blue"))
```

```{r state_wages_ref_points}

wages_st_ref <- bls_wages %>%
  arrange(year) %>%
  group_by(rgn_id) %>%
  filter(year > 2004) %>% #need to select only years 2005 and on to match NOEP dataset
  mutate(state_wages_5yr = rollapply(annual_wage, 5, FUN=mean, align = "right", na.rm=F, partial = T),
         state_wages_prev_5yr = lag(state_wages_5yr, n = 1)) %>%
  filter(year > 2009) %>%
  select(state, year, rgn_id, rgn_name, ref = state_wages_prev_5yr)
  
write.csv(wages_st_ref, file.path(dir_calc, "layers/le_state_wages_ref.csv"))

```

```{r state_wages_and_ref_point}
c <- bls_wages %>%
  left_join(wages_st_ref) %>%
  select(rgn_id, year, annual_wage, ref, rgn_name) %>%
  gather(data, wages, -rgn_id,-year, -rgn_name, -state)

ggplot(c, aes(x = year, y = wages, color = data)) +
  geom_line() +
  facet_wrap(~rgn_name, scales = "free") +
  ylab("Wages per job (USD$") +
  xlab("Year") +
  ggtitle("Average annual wages statewide") +
  scale_color_manual(" ", labels = c("Annual average wages","Mean wages over the \nprevious 5 years"), values = c("blue", "red"))
```

***

#Results

While this is done in the OHI toolbox, the calculated results are duplicated here. TODO

```{r jobs_score}
  ##combining the employment data and calculating the change compared to reference period
  
  ##coastal jobs
  coast_jobs <- coast_jobs %>%
    rename(coast_jobs = rgn_employment) %>%
    left_join(jobs_cst_ref) %>%    #join with the reference point data
    filter(!is.na(ref)) %>%     #remove years with NA for mean jobs (same as removing years pre-2010)
    rename(coast_mean_jobs = ref) %>%
    mutate(cst_chg = coast_jobs/coast_mean_jobs)

  ##state jobs
  state_jobs <- st_jobs %>%
    rename(state_jobs = yr_avg_employed) %>%
    left_join(jobs_st_ref) %>%     #join with the reference point data
    filter(!is.na(ref)) %>%     #remove years with NA for mean jobs (same as removing years pre-2010)
    rename(state_mean_jobs = ref)%>%
    mutate(st_chg = state_jobs/state_mean_jobs)
    
  #combine coastal and state data, calculate jobs scores
  jobs_score <- coast_jobs %>%
    left_join(state_jobs) %>%
    mutate(job_score = ifelse((cst_chg/st_chg) > 1, 1, cst_chg/st_chg)) %>%
    select(rgn_id, year, job_score)
```

```{r wages_scores}
  
  ## Wages scores
  #combining the coastal wage data and calculate the change
  cst_wages <- coast_wages %>%
    left_join(wages_cst_ref) %>%    #join with the reference point data
    filter(!is.na(ref)) %>%       #remove years with NA for wages (same as removing years pre-2010)
    rename(coast_mean_wages = ref) %>%
    mutate(cst_chg = wages_per_job/coast_mean_wages)
  
  #combining the state level wage data
  state_wages <- bls_wages %>%
    left_join(wages_st_ref) %>%     #join with the reference point data
    filter(!is.na(ref)) %>%       #remove years with NA for wages (same as removing years pre-2010)
    rename(state_mean_wages = ref)%>%
    mutate(st_chg = annual_wage/state_mean_wages)
  
  #combine coastal and state data, calculate
  wages_score <- cst_wages %>%
    left_join(state_wages) %>%
    mutate(wages_score = ifelse((cst_chg/st_chg) > 1, 1, cst_chg/st_chg)) %>%
    select(rgn_id, year, wages_score)
```  

## Livelihoods status

Combine jobs and wages scores per region and divide by two
```{r liv_status}  
  # status
  liv_status <- jobs_score %>%
    left_join(wages_score) %>%
    mutate(score = (job_score + wages_score)/2,
           dimension = "status") %>%
    select(year, region_id = rgn_id, score, dimension) %>%
  left_join(rgn_data, by = c("region_id" = "rgn_id"))

ggplot(liv_status, aes(x = year, y = score, color = rgn_name))+
  geom_line() +
  ggtitle("Livelihoods subgoal status scores") +
  ylab("Score") +
  xlab("Year")

```


***

#Citation information  

National Ocean Economics Program. Ocean Economic Data by Sector & Industry., ONLINE. 2012.
Available: http://www.OceanEconomics.org/Market/oceanEcon.asp [17 May 2016]


Bureau of Labor Statistics, U.S. Department of Labor, Quarterly Census of Employment and Wages. 7/24/2016. http://www.bls.gov/cew/](http://www.bls.gov/cew/).