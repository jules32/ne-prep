---
title: 'OHI-Northeast: Economies'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohi-northeast/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---


``` {r setup, echo=F, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(fig.width = 8, fig.height = 6, fig.path = 'figs/', message = FALSE, warning = FALSE, echo=F)

dir_git <- '~/github/ohi-northeast'
dir_rgn <- file.path(dir_git, 'prep/regions')  ### github: general buffer region shapefiles
source(file.path(dir_git, 'src/R/common.R'))  ### an OHI-Northeast specific version of common.R

library(raster)
library(DT)
library(plotly)
library(dplyr)
library(reshape2)

dir_anx <- file.path(dir_M, 'git-annex/neprep')

#round to 2 decimals
options(digits=2, scipen = 999)
```

#Summary

The Economies sub-goal is calculated using coastal GDP data from the [National Ocean Economics Program](http://www.oceaneconomics.org/), and State-wide GDP from the [Bureau of Economic Analysis](http://www.bea.gov/).

***

#Data Sources

##National ocean Economics Program (NOEP)

**Downloaded**: Received from Pat Johston on May 17, 2016.  
**Description**:  GDP [2009 $USD] per sector for RI, ME, MA, CT and NH counties from 2005 to 2013. The data also include number of establishments, jobs and wages for each sector - state - year.  
**Native data resolution**: County level   
**Time range**: 2005 - 2013  
**Format**:  Tabular  

##Bureau of Economic Analysis

**Downloaded**: Accessed October 2, 2017 with R package
**Description**: Regional GDP in chained [2009] $USD for RI, ME, MA, CT and NH  
**Native data resolution**: State level  
**Time range**: 1997 - 2016  
**Format**: Tabular  

https://github.com/us-bea/bea.R

***

# Analysis

Filter raw data

```{r noep_data}

#read in raw data and filter for Sector == All Ocean Sectors
data <- read.csv(file.path(dir_anx,"_raw_data/NOEP/NewEngland_sectors_counties-2.csv"),
                stringsAsFactors=F)%>%
        filter(Sector=='All Ocean Sectors')%>%
        dplyr::select(-Employment, -Establishments, -Wages,-Wages_2009)%>%
        mutate(GDP            = as.numeric(gsub(",","",.$GDP)),
               GDP_2009       = as.numeric(gsub(",","",.$GDP_2009)))

DT::datatable(data, rownames=F, caption = 'Employment in the Tourism & Recreation sector of Coastal Jobs in New England provided by NOEP')

```

More info on the BEA data: https://bea.gov/newsreleases/regional/gdp_state/qgsp_newsrelease.htm

```{r bea_data}

#install.packages('bea.R')
library(bea.R)

#install.packages("striprtf")
library(striprtf)

#read in API access key
beaKey <- read_rtf(file.path(dir_M,'git-annex/neprep/keys/BureauofEconAnalysis.rtf'))

## use beaParams to find the parameters the API call needs to get the Regional GDP data we want.
#beaParams(beaKey, "RegionalProduct") #this function lists the necessary parameters to feed into the beaGet function

beaSpecs <- list(
	'UserID' = beaKey ,
	'Method' = 'GetData',
	'datasetname' = 'RegionalProduct', #name of the table
	'Component' = 'RGDP_SAN',          #this gets the gdp by state annually in 2009 dollars
	'GeoFips' = 'STATE',               #all states (filtered later)
	'IndustryID' = 1,                  #all industries
	'Year' = 'ALL',
	'ResultFormat' = 'json'
);

st_gdp <- beaGet(beaSpecs) %>%
  filter(GeoName %in% c("Connecticut", "New Hampshire", "Maine", "Massachusetts", "Rhode Island", "New York")) %>%
  select(-Code, -GeoFips, -CL_UNIT, -UNIT_MULT) %>%
  gather(key = "Year", value  = "GDP", -GeoName) %>%
  mutate(st_gdp = GDP*100000) %>% #multiply GDP by 1,000,000
  separate(Year, c('X', 'Year'), sep="_") %>%
  select(-X, -GDP) %>%
  rename(State = GeoName) %>%
  mutate(Year = as.integer(Year))

DT::datatable(st_gdp, caption = 'Gross Domestic Product by State (2009 Dollars), provided by the Bureau of Economic Analysis',rownames=FALSE)

```



***

#Methods

The economies score, $xeco '$, is calculated using the following equation; 

$$j ' = \frac{\frac{C_{i}}{C_{r}}}{\frac{T_{i}}{T_{r}}}$$

where $C_{i}$ is the number of coastal jobs in year *i*, $C_{r}$ is the number of coastal jobs in 2005, ${T_{i}}$ is the total number of jobs statewide for year *i* and ${T_{r}}$ is the number of jobs statewide in 2005.


```{r gdp}

gdp <- data%>%
      mutate(County = ifelse(grepl("All",County),"Statewide",County))%>%
          filter(County == 'Statewide')%>%
          mutate(hist_gdp = GDP_2009[which.min(Year)])%>%
          left_join(st_gdp,by=c('State','Year'))%>%
          mutate(cst_chg = GDP_2009/hist_gdp, #use historical reference point from 2005
                 hist_st_gdp = st_gdp[which.min(Year)],
                 st_chg = st_gdp/hist_st_gdp,
                 score = ifelse((cst_chg/st_chg)>1,1,cst_chg/st_chg))%>%as.data.frame()

```

#Results


```{r plot_eco}

eco_plot <- ggplot(gdp,aes(x = Year,y = score, group=State))+
  ggtheme_plot+
  geom_point(aes(color = State)) +
            geom_line(aes(color = State))+
            scale_y_continuous(limits = c(0,1))+
            ggtitle("Economies Scores for the Northeast Regions")+
  labs(y = 'Score')

ggplotly(eco_plot)

ggsave('figs/eco_scores.png')                        
            
```




***

#Citation information  

National Ocean Economics Program. Ocean Economic Data by Sector & Industry., ONLINE. 2012.
Available: http://www.OceanEconomics.org/Market/oceanEcon.asp [17 May 2016]


U.S. Bureau of Economic Analysis, “GDP & Personal Income: Regional Data,” http://bea.gov/iTable/index_regional.cfm (accessed October 2, 2017). 

