---
title: 'OHI-Northeast: Regions'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohi-northeast/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---

Based on the region configuration options in ne_rgn_options, I created a single shapefile with a widely agreed upon configuration. This is not formalized yet but can be used to begin data prep for the assessment.

```{r setup, include=FALSE, message=F,warning=F,echo=F}

knitr::opts_chunk$set(fig.width = 8, fig.height = 6, message = FALSE, warning = FALSE, root.dir = "ohi-northeast")

source('~/github/ohi-northeast/src/R/common.R') ### an OHI-NE specific version of common.R

dir_git <- '~/github/ohi-northeast'
dir_anx <- file.path(dir_M, 'git-annex/neprep')

library(sp)
library(rgdal)
library(tmap)
library(RCurl)
library(raster)
library(rgeos)
library(maptools)

```

## Read in individual shapefiles for the region

```{r read_in_data}

# eez    <- readOGR(dsn = file.path(dir_M,'git-annex/globalprep/spatial/d2014/data'),layer = 'regions_gcs')%>%
#             subset(rgn_nam == 'United States')%>%
#             subset(rgn_typ == 'eez')%>%
#           crop(ne_ext)%>%
#         spTransform(p4s_nad83)

# writeOGR(eez,dsn = 'spatial',layer = 'ne_eez',driver = "ESRI Shapefile")

eez <- readOGR(dsn = '.',layer = 'ne_eez', verbose = FALSE)%>%
        spTransform(p4s_nad83)

plot(eez, col = 'lightblue', main = "EEZ 200 nm off the Northeast United States")

#state land boundaries
states <- readOGR(dsn = file.path(dir_anx,'spatial'),layer = 'states', verbose = FALSE)%>%subset(STATE_NAME %in% c('Maine','New Hampshire','Massachusetts','Vermont','Connecticut','New York','Rhode Island', 'New Jersey','Delaware','Pennsylvania'))%>%
        spTransform(p4s_nad83)

#state waters with some Maine rivers removed (done in QGIS)
state_wa <- readOGR(dsn = file.path(dir_anx,'spatial'), layer = 'StateWaters_wo_rivs_cleaned', verbose = FALSE)%>%
              spTransform(p4s_nad83)
#remove vermont
state_wa <- state_wa %>% subset(!NAME10=="Vermont")
plot(state_wa,col = brewer.pal(8,'Blues'), main = "State Waters in the Northeast")

#marine ecological regions
meow <- readOGR(dsn = file.path(dir_anx,'spatial/MEOW-TNC'),layer = 'meow_ecos_ne', verbose = FALSE)%>%
        spTransform(p4s_nad83)%>%
        crop(extent(-76, -62,37, 47))

meow@data$ECOREGION <- factor(meow@data$ECOREGION)

plot(states)
plot(meow, add=T,col = brewer.pal(3,"Blues"))

#NE ocean plan region of interest - provided by Emily
ne_roi <- readOGR(dsn = file.path(dir_anx,'spatial'),layer = 'ne_plan_poly_bi', verbose = FALSE)%>%
            spTransform(p4s_nad83)

plot(states, main = "Northeast Ocean Planning Boundary")
plot(ne_roi, add = T, col = 'lightblue')

```

## Marine Ecoregions and State Waters

This option combines two regional Marine Ecoregions (MEOWs), Gulf of Maine/Bay of Fundy and the Virginian regions, with state waters in the northeast. Massachusetts state waters are split into two regions where state waters meet the boundary between the two ecoregions. The offshore regions extend to the US EEZ.

```{r meow}
#intersect meow with state waters. The only thing this does is split MASS waters into two polygons, at the boundary between Gulf of Maine and the "Virginian" region

int <- raster::intersect(state_wa,meow)

int@data <- int@data%>%
            dplyr::select(NAME10, ECOREGION)

int@data$NAME10 = as.character(int@data$NAME10)

int@data[5,1] = "Massachusetts-Virginian"
int@data[4,1] = "Massachusetts-Gulf of Maine"


tm_shape(meow)+
    tm_polygons("ECOREGION", title = "Ecoregion", palette = 'Paired')+
tm_shape(states)+
  tm_polygons(col='beige')+
tm_shape(int) + 
  tm_polygons("NAME10", 
        title="State",palette="Pastel2")+
tm_layout(legend.text.size = 0.6,
          legend.position = c("left","top"),
          legend.bg.color = "white",
          legend.bg.alpha = 1)

```

## Marine Ecoregions and State Waters limited to the Northeast Ocean Planning Extent


```{r}

meow_ne <- raster::intersect(ne_roi,meow)

tm_shape(meow_ne)+
    tm_polygons("ECOREGION", title = "Ecoregion", palette = 'Paired')+
tm_shape(int) + 
  tm_polygons("NAME10",title="State",palette="Pastel2")+
tm_layout(legend.text.size = 0.6,
          legend.position = c("left","top"),
          legend.bg.color = "white",
          legend.bg.alpha = 1)

```

## Create single shapefile with all regions

Need to merge `meow_ne` which includes meow regions to state waters and `int` which are all state waters including two portions of MA.

```{r rgns}
# Need to make sure the data is set up the same between the two before merging

int@data <- int@data%>%
              mutate(rgn_id = c(1:7))%>%
              rename(rgn_name = NAME10)%>%
              dplyr::select(rgn_id,rgn_name)

meow_ne@data<- meow_ne@data%>%
                mutate(rgn_id = c(8:9))%>%
                rename(rgn_name = ECOREGION)%>%
                dplyr::select(rgn_id, rgn_name)
                        
#make unique polygon ids
m <- spChFIDs(meow_ne, as.character(meow_ne$rgn_id))
i <- spChFIDs(int, as.character(int$rgn_id))

#merge the two using spRbind
both <- spRbind(i,m)

#project the shapefile then calculate area per polygon

ne_rgns <- spTransform(both,us_alb)

ne_rgns@data$area_km2 <- gArea(ne_rgns,byid=TRUE)/1000000 #divide by 1000m*1000m

tm_shape(ne_rgns)+
    tm_polygons("rgn_name", title = "Regions", palette = 'Paired')+
tm_layout(legend.text.size = 0.6,
          legend.position = c("left","top"),
          legend.bg.color = "white",
          legend.bg.alpha = 1)

#save

#writeOGR(ne_rgns,dsn = '.',layer = 'ne_ohi_rgns', driver = "ESRI Shapefile",overwrite_layer=TRUE)

```


